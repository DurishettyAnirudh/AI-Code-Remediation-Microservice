cwe: CWE-611
name: Improper Restriction of XML External Entity Reference
languages: XML
tags: Base, Draft
---
Short Description:
The product processes an XML document that can contain XML entities with URIs that resolve
to documents outside of the intended sphere of control, causing the product to embed
incorrect documents into its output.

Secure Coding Checklist:
Do:
- PHASE:Implementation System Configuration:Many XML parsers and validators can be configured to disable external entity expansion.
Don't:
- Confidentiality:Avoid situations leading toRead Application Data:Avoid situations leading toRead Files or Directories:NOTE:If the attacker is able to include a crafted DTD and a default entity resolver is enabled, the attacker may be able to access arbitrary files on the system.
- Integrity:Avoid situations leading toBypass Protection Mechanism:NOTE:The DTD may include arbitrary HTTP requests that the server may execute. This could lead to other attacks leveraging the server's trust relationship with other entities.
- Availability:Avoid situations leading toDoS: Resource Consumption (CPU):Avoid situations leading toDoS: Resource Consumption (Memory):NOTE:The product could consume excessive CPU cycles or memory using a URI that points to a large file, or a device that always returns data such as /dev/random. Alternately, the URI could reference a file that contains many nested or recursive entity references to further slow down parsing.

Language-Agnostic Guidance:
XML documents optionally contain a Document Type Definition (DTD), which, among other
features, enables the definition of XML entities. It is possible to define an entity by
providing a substitution string in the form of a URI. The XML parser can access the
contents of this URI and embed these contents back into the XML document for further
processing. By submitting an XML file that defines an external entity with a file:// URI,
an attacker can cause the processing application to read the contents of a local file. For
example, a URI such as file:///c:/winnt/win.ini designates (in Windows) the file
C:Winntwin.ini, or file:///etc/passwd designates the password file in Unix-based systems.
Using URIs with other schemes such as http://, the attacker can force the application to
make outgoing requests to servers that the attacker cannot reach directly, which can be
used to bypass firewall restrictions or hide the source of attacks such as port scanning.
Once the content of the URI is read, it is fed back into the application that is
processing the XML. This application may echo back the data (e.g. in an error message),
thereby exposing the file contents.

::METHOD:Automated Static Analysis:DESCRIPTION:Automated static analysis, commonly
referred to as Static Application Security Testing (SAST), can find some instances of this
weakness by analyzing source code (or binary/compiled code) without having to execute it.
Typically, this is done by building a model of data flow and control flow, then searching
for potentially-vulnerable patterns that connect sources (origins of input) with sinks
(destinations where the data interacts with external components, a lower layer such as the
OS, etc.):EFFECTIVENESS:High::

::PHASE:Implementation System Configuration:DESCRIPTION:Many XML parsers and validators
can be configured to disable external entity expansion.::

Sample Fix Idea (Pseudo-code):
```pseudo
# High-level remediation stub
if receives_untrusted_input():
    validate_against_allowlist()
    enforce_least_privilege()
    log_and_monitor()
```
